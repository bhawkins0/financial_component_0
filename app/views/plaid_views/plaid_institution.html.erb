<style>
 .transactionRow {
   padding: 8px 5px; font-size:11px
 }
  .selector_width{
    width:100px;
  }

/*   @media only screen and (max-width: 600px) {
//   body {
//     background-color: lightblue;
//   }
// }*/
</style>

<div class="container">
  <div class="row page_title_div">
    <div class="col-7 pageTitle">
      <h2 class="display-4"><%=params.fetch("the_institution")%></h2>
    </div>
    <div class="col pageTitle">
      <select id="commit_selector" class="form-select form-select-sm text-dark bg-light clickable" aria-label=".form-select-sm example">
        <%i = 0%>
        <%@matching_commits.each do |commit|%>
          <option value="<%=i%>"><%=commit.to_s%></option>
          <%i = i + 1%>
        <%end%>
        <option value="<%=i%>" selected>Unaudited</option>
      </select>
    </div>
    <div class="col pageTitle justify-content-center">
      <button id="commitAudit" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#exampleModal">Commit</button>
    </div>
  </div>
</div>

<hr>

<div id="plaid_transactions" class="container-fluid overflow-hidden">
  <div class="row">
      <div class="col-2 deskContent"><h6>Account</h6></div>
      <div class="col-2"><h6>Name</h6></div>
      <div class="col-1"><h6>Amount</h6></div>
      <div class="col-2"><h6>Merchant Name</h6></div>
      <div class="col deskContent"><h6>Authorized Date</h6></div>
      <div class="col"><h6>Debit</h6></div>
      <div class="col"><h6>Credit</h6></div>
  </div>
  
  <%debit_acct = 0%>
  <%credit_acct = 0%>
  <%@matching_transactions.each do |trans|%>
    <%if trans.fc_transaction_type == true%>
      <%debit_acct = trans.fc_account_number%>
    <%else%>
      <%credit_acct = trans.fc_account_number%>
      <hr>
      <div id="<%=trans.plaid_transaction_id%>" class="row lh-2">
        <div class="col-2 deskContent"><%=trans.plaid_transaction.plaid_account.plaid_account_name%></div>
        <div class="col-2"><%=trans.plaid_transaction.plaid_name%></div>
        <div class="col-1"><%=trans.fc_amount%></div>
        <div class="col-2"><%=trans.plaid_transaction.plaid_merchant_name%></div>
        <div class="col deskContent"><%=trans.plaid_transaction.plaid_authorized_date%></div>
        <!--<div class="col" style="display:none"><%=trans.plaid_transaction_id%></div>-->
        <div class="col">
          <select id="1" class="form-select form-select-sm selector_width badge text-dark bg-light clickable" aria-label=".form-select-sm example">
            <%i = 1%>
            <%FinancialComponentAccount.where({:fc_account_type => true,:fc_account_name => @matching_accounts}).or(FinancialComponentAccount.where({:fc_statement => "balance_sheet",:fc_account_name => @matching_accounts})).each do |acct|%>
              <%if i == 1%>
                <option value="0"></option>
              <%end%>
              <%if acct.fc_account_number == debit_acct%>
                <option value="<%=i%>" selected><%=acct.fc_account_name%></option>
              <%else%>
                <option value="<%=i%>"><%=acct.fc_account_name%></option>
              <%end%>
              <%i = i + 1%>
            <%end%>
          </select>
        </div>
        <div class="col">
          <select id="0" class="form-select form-select-sm selector_width badge text-dark bg-light clickable" aria-label=".form-select-sm example">
            <%i = 1%>
            <%FinancialComponentAccount.where({:fc_account_type => false,:fc_account_name => @matching_accounts}).or(FinancialComponentAccount.where({:fc_statement => "balance_sheet",:fc_account_name => @matching_accounts})).each do |acct|%>
              <%if i == 1%>
                <option value="0"></option>
              <%end%>
              <%if acct.fc_account_number == credit_acct%>
                <option value="<%=i%>" selected><%=acct.fc_account_name%></option>
              <%else%>
                <option value="<%=i%>"><%=acct.fc_account_name%></option>
              <%end%>
              <%i = i + 1%>
            <%end%>
          </select>
        </div>
      </div>
    <%end%>
  <%end%>
</div>

<div class="modal fade" id="fcModal_1" tabindex="-1" aria-labelledby="fcModal_1_Label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fcModal_1_Label">Financial Component Import</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="fcModal_1_Body">
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <!--<button type="button" class="btn btn-primary">Save changes</button>-->
      </div>
    </div>
  </div>
</div>

<script>
    function sentenceCase(str) {
        if ((str === null) || (str === ''))
            return false;
        else
            str = str.toString();

        return str.replace(/\w\S*/g, function (txt) { return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); });
    }

    $(document).ready(function(){      
      $("select").change(function(){
        if($(this).attr('id') == 'commit_selector'){
          $.post( "/plaid/get_commit/", { institution: '<%=params.fetch("the_institution")%>', transaction_filter:  $("option:selected", this).text() })
            .done(function() {
              alert( "Test" );
            });
        }
        else{
        var a = $("option:selected", this).text();
        var b = $(this).parents(".row").attr('id');
        var c = $(this).attr('id');
        $.post('/plaid/save_account', {
          acct_name: a,
          trans_id: b,
          trans_type: c
        })};
      });

      $("#commitAudit").click(function(){
        $.get('/commit_audit/<%=params.fetch("the_institution")%>', function(data) {
          if (data == 0) {
            $('#fcModal_1_Body').text("Please ensure transactions have both a debit and credit account specified before saving.");
            $('#fcModal_1').modal("show");
          } else if (data == 1) {
            $('#fcModal_1_Body').text(data + " transaction successfully imported!");
            $('#fcModal_1').modal("show");
          }
          else {
            $('#fcModal_1_Body').text(data + " transactions successfully imported!");
            $('#fcModal_1').modal("show");
          };
        });
      });
      $("#fcModal_1").on('hide.bs.modal', function(){
        location.reload();
      });
      
    });
</script>

