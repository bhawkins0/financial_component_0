<head>
  <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/css/intlTelInput.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
</head>

<div class="page_title_div">
  <h2 class="pageTitle display-4">Financial Component Registration</h2>
</div>

<div class="container">
  <form id="editUser" action="/create_user" method="post">
    <div class="row mb-3">
      <label for="first_name_box" class="col-sm-2 col-form-label border-bottom p-3">First Name</label>
      <div class="col-sm-4 border-bottom p-3">
        <input type="text" class="form-control-plaintext bg-light" id="first_name_box" name="query_first_name" placeholder="First Name">
      </div>
      <div class="col-sm-6"></div>
        
      <label for="last_name_box" class="col-sm-2 col-form-label border-bottom p-3">Last Name</label>
      <div class="col-sm-4 border-bottom p-3">
        <input type="text" class="form-control-plaintext bg-light" id="last_name_box" name="query_last_name" placeholder="Last Name">
      </div>
      <div class="col-sm-6"></div>

      <label for="email_box" class="col-sm-2 col-form-label border-bottom p-3">Email</label>
      <div class="col-sm-4 border-bottom p-3">
        <input type="text" class="form-control-plaintext bg-light" id="email_box" name="query_email" placeholder="Email">
      </div>
      <div class="col-sm-6"></div>

      <label for="password_box" class="col-sm-2 col-form-label border-bottom p-3">Password</label>
      <div class="col-sm-4 border-bottom p-3">
        <div class="input-group input-group-sm">
          <input class="form-control-plaintext bg-light" id="password_box" name="query_password" placeholder="Choose a password..." type="password" aria-label="Password" aria-describedby="basic-addon2">
          <span class="input-group-text" id="basic-addon2" onclick="password_show_hide(this.id);">
            <i class="fas fa-eye" id="show_eye"></i>
            <i class="fas fa-eye-slash d-none" id="hide_eye"></i>
          </span>
        </div>
      </div>
      <div class="col-sm-6"></div>

      <label for="password_confirmation_box" class="col-sm-2 col-form-label border-bottom p-3">Password Confirmation</label>
      <div class="col-sm-4 border-bottom p-3">
        <div class="input-group input-group-sm">
          <input class="form-control-plaintext bg-light" id="password_confirmation_box" name="query_password_confirmation" placeholder="Confirm Password" type="password" aria-label="password_confirmation" aria-describedby="basic-addon3">
          <span class="input-group-text" id="basic-addon3" onclick="password_show_hide(this.id);">
            <i class="fas fa-eye" id="show_eye_2"></i>
            <i class="fas fa-eye-slash d-none" id="hide_eye_2"></i>
          </span>
        </div>
      </div>
      <div class="col-sm-6"></div>      

      <label for="mobile_box" class="col-sm-2 col-form-label border-bottom p-3">Mobile</label>
      <div class="col-sm-4 border-bottom p-3">
          <input type="tel" class="form-control-plaintext bg-light" id="mobile_box" name="query_mobile" placeholder="000 000 0000">
      </div>
      <div class="col-sm-6"></div>
    </div>

    <div class="form_prompts">
        <a href="/sign_in">Sign in with existing account</a>
    </div>

    <div class="col-sm-12 p-3">
      <button type="submit" class="btn btn-primary btn-sm">Submit</button>
    </div>
  </form>
</div>

<div class="modal fade" id="fcModal_1" tabindex="-1" aria-labelledby="fcModal_1_Label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fcModal_1_Label">Financial Component Add User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="fcModal_1_Body">
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="email_verification">
  <%= render partial: "user_authentication/email_verification.html.erb", locals: {email_exists: @email_exists, flags: @flags} %>
</div>

<div id="twilio_verification">
  <%= render partial: "user_authentication/twilio_verification.html.erb", locals: {verification_stage: @verification_stage, flags: @flags} %>
</div>

<script>
  const form = document.getElementById('editUser');
  form.addEventListener('submit', validateUser);

  const phoneInputField = document.querySelector("#mobile_box");
  const phoneInput = window.intlTelInput(phoneInputField, {
    utilsScript:
      "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
  });

  const info = document.querySelector(".alert-info");

  function password_show_hide(this_id) {
    if (this_id === "basic-addon2") {
      var x = document.getElementById("password_box");
      var show_eye = document.getElementById("show_eye");
      var hide_eye = document.getElementById("hide_eye");
    } else {
      var x = document.getElementById("password_confirmation_box");
      var show_eye = document.getElementById("show_eye_2");
      var hide_eye = document.getElementById("hide_eye_2");
    };

    hide_eye.classList.remove("d-none");
    if (x.type === "password") {
      x.type = "text";
      show_eye.style.display = "none";
      hide_eye.style.display = "block";
    } else {
      x.type = "password";
      show_eye.style.display = "block";
      hide_eye.style.display = "none";
    }
  }

  function validateUser(event) {
    event.preventDefault();
    const email = document.getElementById("email_box");
    const mobile = document.getElementById("mobile_box");
    var inputs = document.getElementsByTagName("input");
    var flag = 0;
    for(var i = 0; i < inputs.length; i++){
      if (inputs[i].value == ""){
        if((inputs[i].name == "query_email"||inputs[i].name == "query_mobile")){
          if((inputs[i].name == "query_email" && mobile.value == "")||(inputs[i].name == "query_mobile" && email.value == "")){
            $('#fcModal_1_Body').text("Please enter a valid email and/or mobile.");
            $('#fcModal_1').modal("show");
            flag = 1
            break;
            return;
          };
        }
        else {
          $('#fcModal_1_Body').text("Please ensure all fields are completed. You must include a valid " + inputs[i].name.replace("query_","").replace("_box","").replace("_", " ") + ".");
          $('#fcModal_1').modal("show");
          flag = 1
          break;
          return;
        };
      };
    }

    if (flag == 1) {
      return;
    }

    if (email.value != ""){
      if (!validateEmail(email.value)) {
        $('#fcModal_1_Body').text("Please enter a valid email address.");
        $('#fcModal_1').modal("show");
        return;
      } 
      else{
        validate_email(email.value);
      };
    }
    else if (mobile.value != ""){
      validate_mobile(mobile.value);
    };
  }

  function process2(item){
    event.preventDefault();
    $('#fcModal_3').modal('hide');
    $.post( '/validate_mobile_code', { 
      code: item, 
      query_first_name: document.getElementById("first_name_box").value,
      query_last_name: document.getElementById("last_name_box").value,
      query_email: document.getElementById("email_box").value,
      query_password: document.getElementById("password_box").value,
      query_password_confirmation: document.getElementById("password_confirmation_box").value,
      query_mobile: phoneInput.getNumber(),
      flags: 1
      });
  };

  function validateEmail(email) 
  {
      var re = /\S+@\S+\.\S+/;
      return re.test(email);
  }

  function validate_email(email){
    $.ajax({
              beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
              },
              url: "/validate_email",
              type: "POST",
              data: {
                query_first_name: document.getElementById("first_name_box").value,
                query_last_name: document.getElementById("last_name_box").value,
                query_email: email,
                query_password: document.getElementById("password_box").value,
                query_password_confirmation: document.getElementById("password_confirmation_box").value,
                flags: 1
              }
            });
  };

  function validate_mobile(mobile){
    const recipient = phoneInput.getNumber();
    $.ajax({
              beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
              },
              url: "/validate_mobile",
              type: "POST",
              data: {
                recipient: recipient,
                flags: 1
              }
            });
  };

</script>